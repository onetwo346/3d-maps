<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyWorld - Your Personal 3D Navigation Simulation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            overflow: hidden;
            background-color: #0a192f;
            color: white;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #scene-container {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #ui-container {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }

        .panel {
            background-color: rgba(10, 25, 47, 0.85);
            border-radius: 8px;
            padding: 15px;
            backdrop-filter: blur(5px);
            pointer-events: auto;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(100, 255, 218, 0.3);
        }

        #top-panel {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #64ffda;
            margin-bottom: 10px;
            text-align: center;
        }

        .search-container {
            display: flex;
            gap: 10px;
        }

        input {
            flex: 1;
            padding: 10px 15px;
            border-radius: 4px;
            border: 1px solid rgba(100, 255, 218, 0.5);
            background-color: rgba(10, 25, 47, 0.7);
            color: white;
            font-size: 16px;
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        button {
            padding: 10px 20px;
            border-radius: 4px;
            border: none;
            background-color: #64ffda;
            color: #0a192f;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button:hover {
            background-color: #4cd2ac;
            transform: translateY(-2px);
        }

        #side-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 240px;
        }

        .avatar-selection {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .avatar-option {
            text-align: center;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 70px;
        }

        .avatar-option:hover {
            background-color: rgba(100, 255, 218, 0.2);
        }

        .avatar-option.active {
            background-color: rgba(100, 255, 218, 0.3);
            border: 1px solid #64ffda;
        }

        .avatar-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .mode-toggle {
            display: flex;
            margin-top: 15px;
        }

        .mode-option {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mode-option:first-child {
            border-radius: 4px 0 0 4px;
        }

        .mode-option:last-child {
            border-radius: 0 4px 4px 0;
        }

        .mode-option.active {
            background-color: #64ffda;
            color: #0a192f;
        }

        #info-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 240px;
        }

        .info-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .info-icon {
            margin-right: 10px;
            font-size: 18px;
            color: #64ffda;
        }

        .progress-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .loader {
            border: 5px solid rgba(100, 255, 218, 0.3);
            border-radius: 50%;
            border-top: 5px solid #64ffda;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 20px;
            max-width: 300px;
        }

        .hidden {
            display: none;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            #top-panel {
                width: 90%;
            }

            .search-container {
                flex-direction: column;
            }

            #side-panel, #info-panel {
                width: 45%;
                max-width: 180px;
            }

            .avatar-option {
                width: 50px;
                padding: 6px;
            }
        }

        #controls-hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            padding: 10px 20px;
            border-radius: 20px;
            background-color: rgba(100, 255, 218, 0.2);
            font-size: 14px;
        }

        #weather-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 3;
            display: none;
        }

        .raindrop {
            position: absolute;
            width: 2px;
            height: 15px;
            background-color: rgba(184, 213, 238, 0.6);
            border-radius: 0 0 5px 5px;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="scene-container"></div>
        <div id="weather-overlay"></div>
        
        <div id="ui-container">
            <div id="top-panel" class="panel">
                <div class="logo">MyWorld</div>
                <div class="search-container">
                    <input type="text" id="start-location" placeholder="Enter starting location">
                    <input type="text" id="destination" placeholder="Enter destination">
                    <button id="navigate-btn">Navigate</button>
                </div>
            </div>

            <div id="side-panel" class="panel">
                <div class="avatar-selection">
                    <div class="avatar-option active" data-avatar="car">
                        <div class="avatar-icon">üöó</div>
                        <div>Car</div>
                    </div>
                    <div class="avatar-option" data-avatar="person">
                        <div class="avatar-icon">üö∂</div>
                        <div>Person</div>
                    </div>
                    <div class="avatar-option" data-avatar="spaceship">
                        <div class="avatar-icon">üöÄ</div>
                        <div>Ship</div>
                    </div>
                </div>

                <div class="mode-toggle">
                    <div class="mode-option active" data-mode="navigation">Navigation</div>
                    <div class="mode-option" data-mode="free-roam">Free Roam</div>
                </div>
            </div>

            <div id="info-panel" class="panel">
                <div class="info-item">
                    <div class="info-icon">üïí</div>
                    <div>ETA: <span id="eta">--:--</span></div>
                </div>
                <div class="info-item">
                    <div class="info-icon">üõ£Ô∏è</div>
                    <div>Distance: <span id="distance">-- km</span></div>
                </div>
                <div class="info-item">
                    <div class="info-icon">üå¶Ô∏è</div>
                    <div>Weather: <span id="weather">Clear</span></div>
                </div>
                <div class="info-item">
                    <div class="info-icon">üö¶</div>
                    <div>Traffic: <span id="traffic">Low</span></div>
                </div>
            </div>

            <div id="controls-hint" class="panel">
                <div id="desktop-controls">Use W,A,S,D to move | Q,E to rotate | R,F to change altitude</div>
                <div id="mobile-controls" class="hidden">Swipe to move | Pinch to zoom | Two-finger rotate</div>
            </div>

            <div class="progress-loader" id="loader">
                <div class="loader"></div>
                <div class="loading-text">Building your world...</div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const config = {
            avatar: 'car',
            mode: 'navigation',
            isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
            avatarHeight: {
                car: 1.5,
                person: 1.7,
                spaceship: 100
            },
            avatarSpeed: {
                car: 0.3,
                person: 0.1,
                spaceship: 0.8
            }
        };

        // Three.js variables
        let scene, camera, renderer, controls;
        let avatar, ground, buildings = [];
        let clock = new THREE.Clock();
        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false, moveUp = false, moveDown = false;
        let rotateLeft = false, rotateRight = false;
        let velocity = new THREE.Vector3();
        let direction = new THREE.Vector3();
        let rotation = new THREE.Euler(0, 0, 0, 'YXZ');

        // Google Maps variables
        let map, directionsService, directionsRenderer;
        let currentRoute = null;
        let routePoints = [];
        let currentRouteIndex = 0;

        // Weather simulation variables
        let weatherTypes = ['clear', 'rain', 'cloudy'];
        let currentWeather = 'clear';

        // UI elements
        const avatarOptions = document.querySelectorAll('.avatar-option');
        const modeOptions = document.querySelectorAll('.mode-option');
        const navigateBtn = document.getElementById('navigate-btn');
        const startLocationInput = document.getElementById('start-location');
        const destinationInput = document.getElementById('destination');
        const etaSpan = document.getElementById('eta');
        const distanceSpan = document.getElementById('distance');
        const weatherSpan = document.getElementById('weather');
        const trafficSpan = document.getElementById('traffic');
        const loader = document.getElementById('loader');
        const desktopControls = document.getElementById('desktop-controls');
        const mobileControls = document.getElementById('mobile-controls');
        const weatherOverlay = document.getElementById('weather-overlay');

        // Initialize the application
        init();

        // Initialize the scene
        function init() {
            // Update controls display based on device
            if (config.isMobile) {
                desktopControls.classList.add('hidden');
                mobileControls.classList.remove('hidden');
            }

            // Create THREE.js scene
            initThreeJS();
            
            // Initialize Google Maps
            initGoogleMaps();
            
            // Add event listeners
            addEventListeners();
            
            // Start animation loop
            animate();
            
            // Hide loader after initialization
            setTimeout(() => {
                loader.classList.add('hidden');
            }, 3000);
            
            // Demo weather effect (simulated)
            setTimeout(() => {
                changeWeather('rain');
            }, 10000);
            
            // Set random traffic condition every 30 seconds
            setInterval(() => {
                const trafficConditions = ['Low', 'Moderate', 'Heavy'];
                trafficSpan.textContent = trafficConditions[Math.floor(Math.random() * trafficConditions.length)];
            }, 30000);
        }

        // Initialize Three.js scene
        function initThreeJS() {
            // Create scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB); // Sky blue background
            
            // Add fog for distance fade
            scene.fog = new THREE.FogExp2(0x87CEEB, 0.0015);
            
            // Create camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, config.avatarHeight[config.avatar], 5);
            
            // Create renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.getElementById('scene-container').appendChild(renderer.domElement);
            
            // Add ambient light
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            
            // Add directional light (sun)
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(100, 100, 50);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 1024;
            directionalLight.shadow.mapSize.height = 1024;
            scene.add(directionalLight);
            
            // Create the ground
            createGround();
            
            // Create avatar
            createAvatar();
            
            // Create sample environment (temporary placeholder for Google Maps data)
            createSampleEnvironment();
            
            // Handle window resize
            window.addEventListener('resize', onWindowResize, false);
        }

        // Create ground plane
        function createGround() {
            const groundGeometry = new THREE.PlaneGeometry(1000, 1000);
            const groundMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x1a472a, 
                roughness: 0.8,
                metalness: 0.2
            });
            ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
        }

        // Create avatar based on selected type
        function createAvatar() {
            if (avatar) scene.remove(avatar);
            
            let geometry, material;
            
            switch(config.avatar) {
                case 'car':
                    geometry = new THREE.BoxGeometry(2, 1, 4);
                    material = new THREE.MeshStandardMaterial({ color: 0x0066ff });
                    break;
            }
            
            avatar = new THREE.Mesh(geometry, material);
            avatar.castShadow = true;
            avatar.receiveShadow = true;
            
            // Position the avatar based on type
            avatar.position.y = config.avatarHeight[config.avatar] / 2;
            
            // Add avatar to scene
            scene.add(avatar);
            
            // Position camera relative to the avatar
            updateCameraPosition();
                case 'person':
                    geometry = new THREE.CapsuleGeometry(0.5, 1, 4, 8);
                    material = new THREE.MeshStandardMaterial({ color: 0xff6600 });
                    break;
                case 'spaceship':
                    geometry = new THREE.ConeGeometry(1, 3, 8);
                    material = new THREE.MeshStandardMaterial({ color: 0xffcc00 });
                    break;
